# UI-008: Accessibility Enhancements

**Task ID:** UI-008
**Phase:** Phase 1 - MVP
**Category:** UI
**Priority:** P1 (High - Compliance)
**Estimated Effort:** 2-3 days
**Dependencies:** All UI components
**Status:** TO DO

---

## Overview

Ensure all ClearSide UI components meet WCAG 2.1 AA accessibility standards. This includes keyboard navigation, ARIA attributes, screen reader support, focus management, and color contrast compliance.

### Related Documentation
- **Requirements:** `docs/REQUIREMENTS.md` - Accessibility requirements
- **Product Vision:** `docs/01_product-vision.md` - Inclusive design principles

---

## Objectives

1. **WCAG 2.1 AA compliance** for all components
2. **Keyboard navigation** for all interactive elements
3. **ARIA attributes** for semantic richness
4. **Screen reader support** with proper announcements
5. **Focus management** with visible focus indicators
6. **Color contrast** meeting 4.5:1 minimum ratio

---

## Acceptance Criteria

- [ ] All interactive elements are keyboard accessible
- [ ] Tab order is logical
- [ ] Focus indicators are visible (â‰¥3:1 contrast)
- [ ] ARIA labels present where needed
- [ ] Screen reader testing passes (NVDA, JAWS, VoiceOver)
- [ ] Color contrast meets WCAG AA (4.5:1 for normal text, 3:1 for large text)
- [ ] No keyboard traps
- [ ] Form errors announced to screen readers
- [ ] Dynamic content changes announced

---

## Technical Specification

### Focus Management Hook

```typescript
// src/hooks/useFocusTrap.ts

import { useEffect, useRef } from 'react';

/**
 * Trap focus within a container (useful for modals, dropdowns)
 */
export function useFocusTrap<T extends HTMLElement>(isActive: boolean) {
  const containerRef = useRef<T>(null);

  useEffect(() => {
    if (!isActive || !containerRef.current) return;

    const container = containerRef.current;
    const focusableElements = container.querySelectorAll<HTMLElement>(
      'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])'
    );

    const firstElement = focusableElements[0];
    const lastElement = focusableElements[focusableElements.length - 1];

    // Focus first element on mount
    firstElement?.focus();

    const handleTabKey = (e: KeyboardEvent) => {
      if (e.key !== 'Tab') return;

      if (e.shiftKey) {
        // Shift + Tab
        if (document.activeElement === firstElement) {
          e.preventDefault();
          lastElement?.focus();
        }
      } else {
        // Tab
        if (document.activeElement === lastElement) {
          e.preventDefault();
          firstElement?.focus();
        }
      }
    };

    container.addEventListener('keydown', handleTabKey);

    return () => {
      container.removeEventListener('keydown', handleTabKey);
    };
  }, [isActive]);

  return containerRef;
}
```

### Live Region Component

```typescript
// src/components/a11y/LiveRegion/LiveRegion.tsx

import React, { useEffect, useRef } from 'react';

interface LiveRegionProps {
  message: string;
  politeness?: 'polite' | 'assertive';
  clearAfter?: number;
}

/**
 * Screen reader announcement component
 */
export const LiveRegion: React.FC<LiveRegionProps> = ({
  message,
  politeness = 'polite',
  clearAfter = 3000,
}) => {
  const messageRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!message || !messageRef.current) return;

    // Update message
    messageRef.current.textContent = message;

    // Clear after timeout
    if (clearAfter > 0) {
      const timeout = setTimeout(() => {
        if (messageRef.current) {
          messageRef.current.textContent = '';
        }
      }, clearAfter);

      return () => clearTimeout(timeout);
    }
  }, [message, clearAfter]);

  return (
    <div
      ref={messageRef}
      role="status"
      aria-live={politeness}
      aria-atomic="true"
      style={{
        position: 'absolute',
        left: '-10000px',
        width: '1px',
        height: '1px',
        overflow: 'hidden',
      }}
    />
  );
};
```

### Skip Navigation Links

```typescript
// src/components/a11y/SkipLinks/SkipLinks.tsx

import React from 'react';
import styles from './SkipLinks.module.css';

interface SkipLink {
  href: string;
  label: string;
}

const SKIP_LINKS: SkipLink[] = [
  { href: '#main-content', label: 'Skip to main content' },
  { href: '#navigation', label: 'Skip to navigation' },
  { href: '#results', label: 'Skip to results' },
];

export const SkipLinks: React.FC = () => {
  return (
    <nav className={styles.skipLinks} aria-label="Skip links">
      {SKIP_LINKS.map((link) => (
        <a key={link.href} href={link.href} className={styles.skipLink}>
          {link.label}
        </a>
      ))}
    </nav>
  );
};
```

```css
/* src/components/a11y/SkipLinks/SkipLinks.module.css */

.skipLinks {
  position: absolute;
  top: 0;
  left: 0;
  z-index: 10000;
}

.skipLink {
  position: absolute;
  top: -40px;
  left: 0;
  background: var(--color-primary);
  color: white;
  padding: 0.75rem 1.5rem;
  text-decoration: none;
  font-weight: 600;
  z-index: 10000;
  transition: top 0.2s ease;
}

.skipLink:focus {
  top: 0;
}
```

### Accessible Form Field Component

```typescript
// src/components/a11y/FormField/FormField.tsx

import React, { useId } from 'react';
import { Label } from '@/components/ui/Label';
import styles from './FormField.module.css';

interface FormFieldProps {
  label: string;
  error?: string;
  hint?: string;
  required?: boolean;
  children: React.ReactElement;
}

/**
 * Accessible form field wrapper
 */
export const FormField: React.FC<FormFieldProps> = ({
  label,
  error,
  hint,
  required,
  children,
}) => {
  const id = useId();
  const errorId = `${id}-error`;
  const hintId = `${id}-hint`;

  // Clone child element with proper ARIA attributes
  const child = React.cloneElement(children, {
    id,
    'aria-invalid': !!error,
    'aria-describedby': [
      hint ? hintId : null,
      error ? errorId : null,
    ]
      .filter(Boolean)
      .join(' ') || undefined,
    'aria-required': required,
  });

  return (
    <div className={styles.formField}>
      <Label htmlFor={id} required={required}>
        {label}
      </Label>

      {hint && (
        <p id={hintId} className={styles.hint}>
          {hint}
        </p>
      )}

      {child}

      {error && (
        <p id={errorId} className={styles.error} role="alert">
          {error}
        </p>
      )}
    </div>
  );
};
```

### Keyboard Shortcut Hook

```typescript
// src/hooks/useKeyboardShortcut.ts

import { useEffect } from 'react';

interface KeyboardShortcutOptions {
  key: string;
  ctrl?: boolean;
  shift?: boolean;
  alt?: boolean;
  meta?: boolean;
}

export function useKeyboardShortcut(
  options: KeyboardShortcutOptions,
  callback: () => void
) {
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      const matches =
        e.key === options.key &&
        (!options.ctrl || e.ctrlKey) &&
        (!options.shift || e.shiftKey) &&
        (!options.alt || e.altKey) &&
        (!options.meta || e.metaKey);

      if (matches) {
        e.preventDefault();
        callback();
      }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [options, callback]);
}
```

### Focus Visible Styles

```css
/* src/styles/focus.css */

/**
 * Modern focus-visible implementation
 * Only shows focus outline when navigating with keyboard
 */

/* Remove default focus outline */
*:focus {
  outline: none;
}

/* Show focus outline when keyboard navigating */
*:focus-visible {
  outline: 2px solid var(--color-primary);
  outline-offset: 2px;
  border-radius: var(--radius-sm);
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  *:focus-visible {
    outline-width: 3px;
    outline-offset: 3px;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}
```

### Color Contrast Validation

```typescript
// src/utils/a11y/colorContrast.ts

/**
 * Calculate relative luminance for WCAG contrast
 */
function getLuminance(r: number, g: number, b: number): number {
  const [rs, gs, bs] = [r, g, b].map((c) => {
    const val = c / 255;
    return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);
  });

  return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
}

/**
 * Calculate contrast ratio between two colors
 */
export function getContrastRatio(
  color1: { r: number; g: number; b: number },
  color2: { r: number; g: number; b: number }
): number {
  const lum1 = getLuminance(color1.r, color1.g, color1.b);
  const lum2 = getLuminance(color2.r, color2.g, color2.b);

  const lighter = Math.max(lum1, lum2);
  const darker = Math.min(lum1, lum2);

  return (lighter + 0.05) / (darker + 0.05);
}

/**
 * Check if contrast ratio meets WCAG AA standards
 */
export function meetsWCAG_AA(
  foreground: { r: number; g: number; b: number },
  background: { r: number; g: number; b: number },
  isLargeText = false
): boolean {
  const ratio = getContrastRatio(foreground, background);
  const minRatio = isLargeText ? 3 : 4.5;

  return ratio >= minRatio;
}

/**
 * Example usage in tests
 */
export function validateColorPalette() {
  const black = { r: 0, g: 0, b: 0 };
  const white = { r: 255, g: 255, b: 255 };
  const primaryBlue = { r: 37, g: 99, b: 235 };

  console.log('Black on White:', getContrastRatio(black, white)); // 21:1
  console.log('Primary on White:', getContrastRatio(primaryBlue, white)); // Should be > 4.5
}
```

### ARIA Live Region Manager

```typescript
// src/utils/a11y/announcer.ts

/**
 * Global announcer for screen reader messages
 */
class Announcer {
  private container: HTMLDivElement | null = null;

  private ensureContainer() {
    if (this.container) return;

    this.container = document.createElement('div');
    this.container.setAttribute('role', 'status');
    this.container.setAttribute('aria-live', 'polite');
    this.container.setAttribute('aria-atomic', 'true');
    this.container.style.position = 'absolute';
    this.container.style.left = '-10000px';
    this.container.style.width = '1px';
    this.container.style.height = '1px';
    this.container.style.overflow = 'hidden';

    document.body.appendChild(this.container);
  }

  announce(message: string, priority: 'polite' | 'assertive' = 'polite') {
    this.ensureContainer();
    if (!this.container) return;

    this.container.setAttribute('aria-live', priority);
    this.container.textContent = message;

    // Clear after 3 seconds
    setTimeout(() => {
      if (this.container) {
        this.container.textContent = '';
      }
    }, 3000);
  }
}

export const announcer = new Announcer();
```

---

## Testing Requirements

### Automated Accessibility Testing

```typescript
// src/tests/a11y/accessibility.test.tsx

import { render } from '@testing-library/react';
import { axe, toHaveNoViolations } from 'jest-axe';
import { InputForm } from '@/components/InputForm';

expect.extend(toHaveNoViolations);

describe('Accessibility', () => {
  it('InputForm has no accessibility violations', async () => {
    const { container } = render(<InputForm />);
    const results = await axe(container);

    expect(results).toHaveNoViolations();
  });

  it('All interactive elements are keyboard accessible', () => {
    const { getByRole } = render(<InputForm />);

    const button = getByRole('button');
    button.focus();

    expect(document.activeElement).toBe(button);
  });
});
```

### Manual Testing Checklist

```markdown
## Manual Accessibility Testing Checklist

### Keyboard Navigation
- [ ] Tab order is logical
- [ ] All interactive elements are focusable
- [ ] Focus indicators are visible
- [ ] No keyboard traps
- [ ] Enter/Space activates buttons
- [ ] Escape closes modals

### Screen Reader Testing (NVDA/JAWS/VoiceOver)
- [ ] All content is announced
- [ ] Form labels are associated correctly
- [ ] Errors are announced
- [ ] Dynamic content changes are announced
- [ ] ARIA landmarks work correctly

### Visual Testing
- [ ] Text contrast meets 4.5:1 (normal text)
- [ ] Text contrast meets 3:1 (large text, 18pt+)
- [ ] UI is usable at 200% zoom
- [ ] Works in high contrast mode
- [ ] Focus indicators meet 3:1 contrast

### Reduced Motion
- [ ] Animations respect prefers-reduced-motion
- [ ] Essential animations still work
```

---

## Implementation Steps

1. **Day 1:** Implement focus management and keyboard navigation
2. **Day 2:** Add ARIA attributes and screen reader support
3. **Day 3:** Test with automated tools and manual screen reader testing

---

## Validation Steps

- [ ] axe DevTools reports no violations
- [ ] WAVE accessibility tool passes
- [ ] Keyboard navigation works
- [ ] Screen reader testing passes (NVDA, JAWS, VoiceOver)
- [ ] Color contrast meets WCAG AA
- [ ] Focus indicators visible
- [ ] Reduced motion respected

---

**Last Updated:** 2025-12-23
